<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Issue - CivicTrack</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <header class="dashboard-header">
            <h1>Report a Civic Issue</h1>
            <a href="index.html" class="btn-secondary">Back to Home</a>
        </header>

        <main class="dashboard-content">
            <div class="report-section">
                <div class="report-form-card">
                    <h2>Submit Your Complaint</h2>
                    <form id="complaint-form" enctype="multipart/form-data">
                        <div class="form-section">
                            <h3>Issue Details</h3>

                            <div class="form-group">
                                <label for="title">Issue Title *</label>
                                <input type="text" id="title" name="title" placeholder="Brief description of the issue" required>
                            </div>

                            <div class="form-group">
                                <label for="category">Category *</label>
                                <select id="category" name="category" required>
                                    <option value="">Select a category</option>
                                    <option value="Roads & Infrastructure">Roads & Infrastructure</option>
                                    <option value="Sanitation">Sanitation</option>
                                    <option value="Water Supply">Water Supply</option>
                                    <option value="Electricity">Electricity</option>
                                    <option value="Public Transport">Public Transport</option>
                                    <option value="Street Lighting">Street Lighting</option>
                                    <option value="Parks & Gardens">Parks & Gardens</option>
                                    <option value="Traffic Signals">Traffic Signals</option>
                                    <option value="Waste Management">Waste Management</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="description">Description *</label>
                                <textarea id="description" name="description" rows="4" placeholder="Detailed description of the issue..." required></textarea>
                            </div>

                            <div class="form-group">
                                <label for="priority">Priority Level</label>
                                <select id="priority" name="priority">
                                    <option value="low">Low - Minor inconvenience</option>
                                    <option value="medium" selected>Medium - Needs attention</option>
                                    <option value="high">High - Urgent issue</option>
                                    <option value="critical">Critical - Emergency</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Location</h3>

                            <div class="form-group">
                                <label for="address">Address</label>
                                <input type="text" id="address" name="address" placeholder="Street address or landmark">
                            </div>

                            <div class="form-group">
                                <label for="landmark">Landmark</label>
                                <input type="text" id="landmark" name="landmark" placeholder="Nearby landmark or building">
                            </div>

                            <div class="map-container">
                                <label>Location on Map *</label>
                                <div id="map" style="height: 300px; border-radius: 4px;"></div>
                                <input type="hidden" id="latitude" name="latitude" required>
                                <input type="hidden" id="longitude" name="longitude" required>
                                <small class="form-help">Click on the map to set the exact location</small>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Photos (Optional)</h3>
                            <div class="form-group">
                                <label for="images">Upload Images</label>
                                <input type="file" id="images" name="images" multiple accept="image/*">
                                <small class="form-help">You can upload up to 5 images (max 5MB each)</small>
                                <div id="image-preview" class="image-preview"></div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Contact Information</h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="name">Your Name *</label>
                                    <input type="text" id="name" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email Address *</label>
                                    <input type="email" id="email" name="email" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" name="phone">
                                </div>
                                <div class="form-group">
                                    <label for="city">City *</label>
                                    <input type="text" id="city" name="city" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Submit Complaint</button>
                            <button type="button" id="reset-btn" class="btn-secondary">Reset Form</button>
                        </div>
                    </form>

                    <div id="form-message" class="form-message" style="display: none;"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/dataManager.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/map.js"></script>
    <script>
        let map;
        let marker;

        // Initialize map using MapManager
        function initMap() {
            window.mapInstances.reportMap = new MapManager('map', {
                enableClick: true,
                enableGeolocation: true
            });
            map = window.mapInstances.reportMap.map;
            marker = window.mapInstances.reportMap.marker;
        }

        function setLocation(lat, lng) {
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            if (marker) {
                map.removeLayer(marker);
            }

            marker = L.marker([lat, lng]).addTo(map);
        }

        // Image preview
        document.getElementById('images').addEventListener('change', function(e) {
            const files = e.target.files;
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '';

            for (let i = 0; i < files.length && i < 5; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-image';
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        // Form submission
        document.getElementById('complaint-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Submitting...';
            submitBtn.disabled = true;

            const formData = new FormData(this);
            const formMessage = document.getElementById('form-message');

            // Reset message
            formMessage.style.display = 'none';

            try {
                // Create complaint object from form data
                const complaint = {
                    id: Date.now(), // Simple ID generation
                    tracking_id: 'CT' + Date.now().toString().slice(-8),
                    title: formData.get('title'),
                    category: formData.get('category'),
                    description: formData.get('description'),
                    priority: formData.get('priority'),
                    address: formData.get('address'),
                    landmark: formData.get('landmark'),
                    latitude: parseFloat(formData.get('latitude')),
                    longitude: parseFloat(formData.get('longitude')),
                    name: formData.get('name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    city: formData.get('city'),
                    status: 'submitted',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    images: [] // Would handle file uploads in a real implementation
                };

                // Save complaint using dataManager
                const success = window.dataManager.addComplaint(complaint);

                if (success) {
                    formMessage.className = 'form-message success';
                    formMessage.innerHTML = `
                        <h3>Complaint Submitted Successfully!</h3>
                        <p><strong>Tracking ID:</strong> ${complaint.tracking_id}</p>
                        <p>You can track your complaint status using this ID.</p>
                        <p>Please save this tracking ID for future reference.</p>
                    `;
                    this.reset();
                    document.getElementById('image-preview').innerHTML = '';
                    if (marker) {
                        map.removeLayer(marker);
                        marker = null;
                    }
                } else {
                    formMessage.className = 'form-message error';
                    formMessage.textContent = 'Failed to submit complaint. Please try again.';
                }
            } catch (error) {
                console.error('Failed to submit complaint:', error);
                formMessage.className = 'form-message error';
                formMessage.textContent = 'Error submitting complaint. Please try again later.';
            } finally {
                formMessage.style.display = 'block';
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Reset form
        document.getElementById('reset-btn').addEventListener('click', function() {
            document.getElementById('complaint-form').reset();
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('form-message').style.display = 'none';
            if (marker) {
                map.removeLayer(marker);
                marker = null;
            }
        });

        // Initialize map when page loads
        initMap();
    </script>

    <style>
        body {
            font-family: 'Roboto', 'Noto Sans', Arial, sans-serif;
            background-color: #F5F5F5;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #FF9933 0%, #FFFFFF 50%, #128807 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #CCCCCC;
        }

        .dashboard-header h1 {
            color: #333333;
            margin: 0;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            font-size: 2rem;
            font-weight: 700;
        }

        .btn-secondary {
            background: #0066CC;
            color: #FFFFFF;
            border: 2px solid #0066CC;
            padding: 10px 20px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 600;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #004499;
            border-color: #004499;
            color: #FFFFFF;
        }

        .report-section {
            max-width: 900px;
            margin: 0 auto;
        }

        .report-form-card {
            background: #FFFFFF;
            padding: 30px;
            border: 1px solid #CCCCCC;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #CCCCCC;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h3 {
            color: #333333;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #FF9933;
            padding-bottom: 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333333;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #CCCCCC;
            border-radius: 4px;
            font-size: 16px;
            background: #FFFFFF;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #0066CC;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        select.form-control {
            cursor: pointer;
        }

        .form-help {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666666;
        }

        .map-container {
            margin-top: 10px;
        }

        .image-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .preview-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #CCCCCC;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #CCCCCC;
        }

        .btn-primary, .btn-secondary {
            padding: 12px 30px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #FF9933;
            color: #FFFFFF;
            border: 2px solid #FF9933;
        }

        .btn-primary:hover {
            background: #FF8C00;
            border-color: #FF8C00;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 153, 51, 0.3);
        }

        .btn-primary:disabled {
            background: #CCCCCC;
            border-color: #CCCCCC;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #FFFFFF;
            color: #0066CC;
            border: 2px solid #0066CC;
        }

        .btn-secondary:hover {
            background: #0066CC;
            color: #FFFFFF;
        }

        .form-message {
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
            font-weight: 500;
            border-left: 4px solid;
        }

        .form-message.success {
            background: rgba(18, 136, 7, 0.1);
            color: #128807;
            border-color: #128807;
        }

        .form-message.error {
            background: rgba(220, 20, 60, 0.1);
            color: #DC143C;
            border-color: #DC143C;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn-primary, .btn-secondary {
                width: 100%;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</body>
</html>
