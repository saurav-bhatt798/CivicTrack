<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Status - CivicTrack</title>
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <div class="container">
        <header class="dashboard-header">
            <h1>Track Complaint Status</h1>
            <a href="index.html" class="btn-secondary">Back to Home</a>
        </header>

        <main class="dashboard-content">
            <div class="track-section">
                <div class="track-form-card">
                    <h2>Enter Tracking Information</h2>
                    <form id="track-form">
                        <div class="form-group">
                            <label for="tracking-id">Tracking ID</label>
                            <input type="text" id="tracking-id" name="trackingId" placeholder="Enter your tracking ID" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" name="email" placeholder="Enter your email" required>
                        </div>
                        <button type="submit" class="btn-primary">Track Complaint</button>
                    </form>
                </div>

                <div id="complaint-details" class="complaint-details-card" style="display: none;">
                    <h2>Complaint Details</h2>
                    <div id="complaint-info">
                        <!-- Complaint information will be loaded here -->
                    </div>
                </div>

                <div id="error-message" class="error-message" style="display: none;">
                    <!-- Error messages will be shown here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        document.getElementById('track-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const trackingId = document.getElementById('tracking-id').value;
            const email = document.getElementById('email').value;

            const errorMessage = document.getElementById('error-message');
            const complaintDetails = document.getElementById('complaint-details');
            const complaintInfo = document.getElementById('complaint-info');

            // Reset messages
            errorMessage.style.display = 'none';
            complaintDetails.style.display = 'none';

            try {
                const response = await fetch(`/api/complaints/track/${trackingId}?email=${encodeURIComponent(email)}`);
                const data = await response.json();

                if (data.success) {
                    displayComplaintDetails(data.complaint);
                    complaintDetails.style.display = 'block';
                } else {
                    errorMessage.textContent = data.message || 'Complaint not found';
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to track complaint:', error);
                errorMessage.textContent = 'Network error. Please try again.';
                errorMessage.style.display = 'block';
            }
        });

        function displayComplaintDetails(complaint) {
            const complaintInfo = document.getElementById('complaint-info');

            const statusClass = getStatusClass(complaint.status);
            const createdDate = new Date(complaint.created_at).toLocaleDateString();
            const updatedDate = new Date(complaint.updated_at).toLocaleDateString();

            complaintInfo.innerHTML = `
                <div class="complaint-header">
                    <div class="tracking-id">Tracking ID: <strong>${complaint.tracking_id}</strong></div>
                    <div class="status">
                        <span class="status-badge ${statusClass}">${complaint.status.replace('_', ' ')}</span>
                    </div>
                </div>

                <div class="complaint-body">
                    <div class="detail-row">
                        <strong>Title:</strong> ${complaint.title}
                    </div>
                    <div class="detail-row">
                        <strong>Category:</strong> ${complaint.category}
                    </div>
                    <div class="detail-row">
                        <strong>Description:</strong> ${complaint.description}
                    </div>
                    <div class="detail-row">
                        <strong>Location:</strong> ${complaint.latitude}, ${complaint.longitude}
                    </div>
                    <div class="detail-row">
                        <strong>Submitted:</strong> ${createdDate}
                    </div>
                    <div class="detail-row">
                        <strong>Last Updated:</strong> ${updatedDate}
                    </div>
                </div>

                ${complaint.images && complaint.images.length > 0 ? `
                    <div class="complaint-images">
                        <h3>Images</h3>
                        <div class="image-gallery">
                            ${complaint.images.map(image => `
                                <img src="/uploads/complaints/${image.image_path}" alt="Complaint image" onclick="openImageModal(this.src)">
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <div class="complaint-timeline">
                    <h3>Status Timeline</h3>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <div class="timeline-title">Complaint Submitted</div>
                                <div class="timeline-date">${createdDate}</div>
                            </div>
                        </div>
                        ${complaint.status !== 'submitted' ? `
                            <div class="timeline-item">
                                <div class="timeline-marker active"></div>
                                <div class="timeline-content">
                                    <div class="timeline-title">Status: ${complaint.status.replace('_', ' ')}</div>
                                    <div class="timeline-date">${updatedDate}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function getStatusClass(status) {
            const statusMap = {
                'submitted': 'status-submitted',
                'in_progress': 'status-in-progress',
                'resolved': 'status-resolved',
                'rejected': 'status-rejected'
            };
            return statusMap[status] || 'status-submitted';
        }

        function openImageModal(src) {
            // Create modal for image viewing
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <img src="${src}" alt="Complaint image">
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
    </script>

    <style>
        .track-section {
            max-width: 800px;
            margin: 0 auto;
        }

        .track-form-card, .complaint-details-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #c33;
            margin-bottom: 20px;
        }

        .complaint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .tracking-id {
            font-size: 18px;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            text-transform: capitalize;
        }

        .status-submitted { background: #e3f2fd; color: #1976d2; }
        .status-in-progress { background: #fff3e0; color: #f57c00; }
        .status-resolved { background: #e8f5e8; color: #388e3c; }
        .status-rejected { background: #ffebee; color: #d32f2f; }

        .detail-row {
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .image-gallery {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .image-gallery img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ddd;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-marker {
            position: absolute;
            left: -22px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
        }

        .timeline-marker.active {
            background: #3498db;
        }

        .timeline-content {
            background: #f9f9f9;
            padding: 10px 15px;
            border-radius: 4px;
        }

        .timeline-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .timeline-date {
            font-size: 12px;
            color: #666;
        }

        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 4px;
        }

        .close-modal {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
    </style>
</body>
</html>
