<!-- public/public-map.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicTrack - Public Issue Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/style.css">
    <style>
        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .map-controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .map-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 14px;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-width: 150px;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .legend-text {
            font-size: 14px;
            color: var(--dark-color);
        }
        
        .map-stats {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--light-color);
            border-radius: 8px;
            min-width: 120px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--dark-color);
            margin-top: 5px;
        }
        
        .map-info-window {
            max-width: 300px;
        }
        
        .info-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-details {
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--dark-color);
        }
        
        .info-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .status-submitted { background: #ffebee; color: #c62828; }
        .status-in_progress { background: #fff3e0; color: #ef6c00; }
        .status-resolved { background: #e8f5e9; color: #2e7d32; }
        
        .info-images {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        
        .info-image {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .info-image:hover {
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            #map {
                height: 400px;
            }
            
            .map-filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header (Same as landing page) -->
    <header id="mainHeader">
        <div class="header-wrapper">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="logo">
                            <a href="index.html" title="Go to home" class="site_logo">
                                <div class="logo_text">
                                    <strong>CivicTrack</strong>
                                    <span class="logo_subtitle">Public Issue Map</span>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="col text-right">
                        <a href="login.html" class="btn btn-secondary">Login</a>
                        <a href="index.html" class="btn ml-2">Home</a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="menuWrapper">
            <div class="container">
                <nav class="menu">
                    <ul class="nav">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="public-map.html" class="active">Public Map</a></li>
                        <li><a href="report-issue.html">Report Issue</a></li>
                        <li><a href="track-status.html">Track Status</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="login.html">Login</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main class="container py-4">
        <div class="map-controls">
            <h2 class="section-title mb-3">Public Issue Map</h2>
            <p class="mb-4">View all reported civic issues in your area. Click on markers for details.</p>
            
            <div class="map-filters">
                <div class="filter-group">
                    <label for="categoryFilter">Issue Type</label>
                    <select id="categoryFilter">
                        <option value="all">All Types</option>
                        <option value="road-damage">Road Damage</option>
                        <option value="street-light">Street Light</option>
                        <option value="garbage">Garbage Overflow</option>
                        <option value="water-supply">Water Supply</option>
                        <option value="drainage">Drainage</option>
                        <option value="public-property">Public Property</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="submitted">Submitted</option>
                        <option value="in_progress">In Progress</option>
                        <option value="resolved">Resolved</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="timeFilter">Time Period</label>
                    <select id="timeFilter">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button id="applyFilters" class="btn">Apply Filters</button>
                </div>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span class="legend-text">Submitted / Pending</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f39c12;"></div>
                    <span class="legend-text">In Progress</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #27ae60;"></div>
                    <span class="legend-text">Resolved</span>
                </div>
            </div>
        </div>

        <div id="map"></div>
        
        <div class="map-stats">
            <div class="stat-item">
                <div class="stat-number" id="totalComplaints">0</div>
                <div class="stat-label">Total Issues</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="pendingComplaints">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="inProgressComplaints">0</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="resolvedComplaints">0</div>
                <div class="stat-label">Resolved</div>
            </div>
        </div>
        
        <div class="mt-4">
            <h3>How to Use This Map</h3>
            <ul>
                <li>Click on any marker to see issue details</li>
                <li>Use filters to view specific issue types or statuses</li>
                <li>Zoom in/out to see issues in specific areas</li>
                <li>Red markers = Pending, Yellow = In Progress, Green = Resolved</li>
            </ul>
            <p class="mt-2">
                <a href="report-issue.html" class="btn">Report New Issue</a>
                <a href="track-status.html" class="btn btn-secondary ml-2">Track Your Complaint</a>
            </p>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/js/map.js"></script>
    <script>
    // Public Map JavaScript
    class PublicMap {
        constructor() {
            this.map = null;
            this.markers = [];
            this.currentFilters = {
                category: 'all',
                status: 'all',
                time: 'all'
            };
            this.bounds = null;
            
            this.initMap();
            this.loadComplaints();
            this.setupEventListeners();
        }
        
        initMap() {
            // Default to New Delhi coordinates
            const defaultLat = 28.6139;
            const defaultLng = 77.2090;
            
            this.map = L.map('map').setView([defaultLat, defaultLng], 12);
            
            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(this.map);
            
            // Add scale control
            L.control.scale().addTo(this.map);
            
            // Store map bounds for filtering
            this.map.on('moveend', () => {
                this.bounds = this.map.getBounds();
                this.loadComplaints();
            });
        }
        
        loadComplaints() {
            try {
                // Clear existing markers
                this.clearMarkers();

                // Get complaints from localStorage via dataManager
                let complaints = window.dataManager.getComplaints();

                // Apply filters
                if (this.currentFilters.category !== 'all') {
                    complaints = complaints.filter(c => c.category === this.currentFilters.category);
                }

                if (this.currentFilters.status !== 'all') {
                    complaints = complaints.filter(c => c.status === this.currentFilters.status);
                }

                // Apply time filter
                if (this.currentFilters.time !== 'all') {
                    const now = new Date();
                    let startDate = new Date();

                    switch (this.currentFilters.time) {
                        case 'today':
                            startDate.setHours(0, 0, 0, 0);
                            break;
                        case 'week':
                            startDate.setDate(now.getDate() - 7);
                            break;
                        case 'month':
                            startDate.setMonth(now.getMonth() - 1);
                            break;
                    }

                    complaints = complaints.filter(c => new Date(c.created_at) >= startDate);
                }

                // Filter by bounds if available
                if (this.bounds) {
                    complaints = complaints.filter(c => {
                        const lat = parseFloat(c.latitude);
                        const lng = parseFloat(c.longitude);
                        return this.bounds.contains([lat, lng]);
                    });
                }

                this.displayComplaints(complaints);
                this.updateStatistics(complaints);

            } catch (error) {
                console.error('Error loading complaints:', error);
            }
        }
        
        displayComplaints(complaints) {
            complaints.forEach(complaint => {
                const marker = this.createMarker(complaint);
                marker.addTo(this.map);
                this.markers.push(marker);
            });
            
            // Fit bounds to markers if we have any
            if (this.markers.length > 0) {
                const group = new L.featureGroup(this.markers);
                this.map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        createMarker(complaint) {
            // Choose marker color based on status
            let markerColor;
            switch(complaint.status) {
                case 'submitted':
                    markerColor = '#e74c3c'; // Red
                    break;
                case 'in_progress':
                    markerColor = '#f39c12'; // Orange
                    break;
                case 'resolved':
                    markerColor = '#27ae60'; // Green
                    break;
                default:
                    markerColor = '#3498db'; // Blue
            }
            
            // Create custom icon
            const icon = L.divIcon({
                html: `<div style="
                    background: ${markerColor};
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 2px solid white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    cursor: pointer;
                "></div>`,
                className: 'custom-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            // Create marker
            const marker = L.marker([complaint.latitude, complaint.longitude], { icon: icon });
            
            // Add popup
            const popupContent = this.createPopupContent(complaint);
            marker.bindPopup(popupContent, {
                maxWidth: 300,
                className: 'map-popup'
            });
            
            return marker;
        }
        
        createPopupContent(complaint) {
            const statusClass = `status-${complaint.status}`;
            const statusText = complaint.status.replace('_', ' ').toUpperCase();
            
            // Format date
            const date = new Date(complaint.created_at);
            const formattedDate = date.toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
            
            return `
                <div class="map-info-window">
                    <div class="info-title">${complaint.title}</div>
                    <div class="info-details">
                        <strong>Type:</strong> ${complaint.category.replace('-', ' ')}<br>
                        <strong>Location:</strong> ${complaint.address || 'Not specified'}<br>
                        <strong>Reported:</strong> ${formattedDate}<br>
                        <strong>Priority:</strong> ${complaint.priority}
                    </div>
                    <div class="info-status ${statusClass}">${statusText}</div>
                    <p>${complaint.description.substring(0, 100)}...</p>
                    <div class="mt-2">
                        <a href="complaint.html?id=${complaint.id}" target="_blank" class="btn" style="font-size: 12px; padding: 5px 10px;">
                            View Details
                        </a>
                    </div>
                </div>
            `;
        }
        
        updateStatistics(complaints) {
            const total = complaints.length;
            const pending = complaints.filter(c => c.status === 'submitted').length;
            const inProgress = complaints.filter(c => c.status === 'in_progress').length;
            const resolved = complaints.filter(c => c.status === 'resolved').length;
            
            document.getElementById('totalComplaints').textContent = total;
            document.getElementById('pendingComplaints').textContent = pending;
            document.getElementById('inProgressComplaints').textContent = inProgress;
            document.getElementById('resolvedComplaints').textContent = resolved;
        }
        
        clearMarkers() {
            this.markers.forEach(marker => {
                marker.remove();
            });
            this.markers = [];
        }
        
        setupEventListeners() {
            document.getElementById('applyFilters').addEventListener('click', () => {
                this.currentFilters.category = document.getElementById('categoryFilter').value;
                this.currentFilters.status = document.getElementById('statusFilter').value;
                this.currentFilters.time = document.getElementById('timeFilter').value;
                this.loadComplaints();
            });
            
            // Auto-apply filters when changed
            ['categoryFilter', 'statusFilter', 'timeFilter'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    this.currentFilters.category = document.getElementById('categoryFilter').value;
                    this.currentFilters.status = document.getElementById('statusFilter').value;
                    this.currentFilters.time = document.getElementById('timeFilter').value;
                    this.loadComplaints();
                });
            });
        }
    }
    
    // Initialize map when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        window.publicMap = new PublicMap();
    });
    </script>
</body>
</html>